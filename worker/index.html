<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KV Manager</title>
<style>
  body {
    background: #0d0d0d;
    color: #fff;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
  }
  h1 { font-size: 28px; margin-bottom: 20px; }
  .box {
    background: #1a1a1a;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 30px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border-bottom: 1px solid #333;
    padding: 10px;
    text-align: left;
  }
  button {
    padding: 6px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  .edit { background: #0077ff; color: white; }
  .delete { background: #ff0033; color: white; }
  .newkey { background: #00cc66; color: white; margin-top: 10px; }
  input {
    background: #111;
    border: 1px solid #444;
    color: white;
    padding: 8px;
    border-radius: 6px;
    width: 100%;
  }
  #modal {
    display: none;
    position: fixed;
    inset: 0;
    background: #000000aa;
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
  }
  #modalContent {
    background: #1a1a1a;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    border-radius: 12px;
  }
  .exportBtn { background: #ffcc00; color: #111; margin-bottom: 15px; }
</style>
</head>
<body>

<h1>KV Manager Dashboard</h1>
<div class="box">
  <button class="newkey exportBtn" onclick="exportPDF()">Export PDF</button>
  <button class="newkey" onclick="openCreate()">+ New Key</button>
  <table id="kvTable">
    <thead>
      <tr><th>Key</th><th>Value</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="modal">
  <div id="modalContent">
    <h2 id="modalTitle"></h2>
    <label>Key:</label>
    <input id="modalKey"><br><br>
    <label>Value:</label>
    <input id="modalValue"><br><br>
    <button class="newkey" onclick="saveModal()">Save</button>
    <button class="delete" onclick="closeModal()" style="float:right;">Cancel</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const API_EXPORT = "https://main-website-track.mahdiyasser526.workers.dev/export";
let editing = null;

async function load() {
  const res = await fetch(API_EXPORT, { credentials: "include" });
  const data = await res.json();
  const tbody = document.querySelector('#kvTable tbody');
  tbody.innerHTML = '';

  Object.entries(data).forEach(([key, value]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${key}</td>
      <td>${value}</td>
      <td>
        <button class="edit" onclick="openEdit('${key}', '${value}')">Edit</button>
        <button class="delete" onclick="deleteKey('${key}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function openEdit(key, value) {
  editing = key;
  document.getElementById('modalTitle').innerText = "Edit Key";
  document.getElementById('modalKey').value = key;
  document.getElementById('modalKey').disabled = true;
  document.getElementById('modalValue').value = value;
  document.getElementById('modal').style.display = "flex";
}

function openCreate() {
  editing = null;
  document.getElementById('modalTitle').innerText = "Create Key";
  document.getElementById('modalKey').value = "";
  document.getElementById('modalKey').disabled = false;
  document.getElementById('modalValue').value = "";
  document.getElementById('modal').style.display = "flex";
}

async function saveModal() {
  const key = document.getElementById('modalKey').value.trim();
  const val = document.getElementById('modalValue').value.trim();
  if (!key) return alert("Key cannot be empty");

  // Use POST to the root worker, it will auto create or update KV keys
  await fetch("https://main-website-track.mahdiyasser526.workers.dev", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type: "page", name: key }) // type can be page/tool as needed
  });

  closeModal();
  load();
}

function closeModal() {
  document.getElementById('modal').style.display = "none";
}

async function exportPDF() {
  const res = await fetch(API_EXPORT, { credentials: "include" });
  const data = await res.json();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;
  doc.setFontSize(12);
  for (const [k,v] of Object.entries(data)) {
    doc.text(`${k}: ${v}`, 10, y);
    y += 10;
    if (y > 280) { doc.addPage(); y = 10; }
  }
  doc.save("kv_export.pdf");
}

load();
</script>

</body>
</html>

