<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahdi Yasser Blog | Sandbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Monoton&family=Cutive+Mono&family=Permanent+Marker&family=Courier+Prime&family=Indie+Flower&family=Bebas+Neue&display=swap" rel="stylesheet">
    
    <style>
        /* Reusing global CSS variables for consistent theming */
        :root {
            --primary-color: #3b82f6; /* Blue 500 */
            --primary-hover: #2563eb; /* Blue 600 */
            --danger-color: #ef4444; /* Red 500 */
            --secondary-color: #6b7280; /* Gray 500 */
            --bg-light: #f3f4f6; /* Gray 100 */
            --border-color: #e5e7eb; /* Gray 200 - Added for consistency */
            --border-radius: 16px; /* Added for consistency */
            
            /* Theme Variables (Light Mode Default) */
            --bg-default: var(--bg-light);
            --bg-paper: #ffffff;
            --text-default: #1f2937; /* Gray 800 */
            --text-secondary: var(--secondary-color);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.5); /* Adjusted for consistency */
            
            /* Custom Shadows for Visibility: Red for Invalid, Green for Valid, Blue for Secondary */
            --cta-shadow-success: 0 10px 20px -5px rgba(5, 150, 105, 0.5); /* Green-600 shadow */
            --cta-shadow-danger: 0 10px 20px -5px rgba(239, 68, 68, 0.5); /* Red-500 shadow */
        }

        html.dark:root {
            --bg-default: #111827; /* Gray 900 */
            --bg-paper: #1f2937; /* Gray 800 */
            --text-default: #f3f4f6; /* Gray 100 */
            --text-secondary: #9ca3af; /* Gray 400 */
            --border-color: #374151; /* Gray 700 - Added for consistency */
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5); /* Added for consistency */
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: var(--bg-default);
            color: var(--text-default);
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Custom Button Shadow Styles (for light mode visibility) --- */
        .cta-pop-shadow-success {
            box-shadow: var(--cta-shadow-success);
        }
        
        .cta-pop-shadow-danger {
            box-shadow: var(--cta-shadow-danger);
        }

        /* In Dark Mode, revert to the generic shadow for a cleaner look */
        html.dark .cta-pop-shadow-success,
        html.dark .cta-pop-shadow-danger { 
            box-shadow: var(--shadow-lg); /* Use the standard shadow property */
        }
        /* --- End Custom Button Shadow Styles --- */


        /* --- Custom Styles for Form Sliding Effect --- */

        /* Flex container ensures smooth sliding without weird spacing */
        .form-slider {
            display: flex;
            transition: transform 0.4s ease-in-out; 
            width: 100%;
        }

        /* Each step takes up 100% of the container width */
        .form-step {
            min-width: 100%;
            box-sizing: border-box;
        }
        
        /* Responsive Embed (for YouTube) */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* --- POST PREVIEW STYLES (EXACT MATCH) --- */
        #post-detail-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-default); z-index: 2000; overflow-y: auto;
            /* Use transform for smooth slide-in/out */
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            display: none;
        }
        #post-detail-page.active { transform: translateX(0); display: block; }

        .detail-header {
            background-color: var(--bg-paper); padding: 15px 30px;
            box-shadow: var(--shadow-lg); position: sticky; top: 0; z-index: 10;
            display: flex; align-items: center; border-bottom: 1px solid var(--border-color);
        }

        .back-btn {
            background: none; border: none; color: var(--text-default); font-size: 1.2em;
            cursor: pointer; padding: 8px 15px; margin: 0; line-height: 1;
            display: flex; align-items: center; gap: 8px; border-radius: 12px;
            transition: background-color 0.2s, color 0.2s; font-weight: 500;
        }
        .back-btn:hover { background-color: rgba(59, 130, 246, 0.1); color: var(--primary-color); }
        .back-btn .icon { font-size: 20px; font-weight: 900; }

        .detail-content-wrapper {
            max-width: 1000px; margin: 30px auto; padding: 40px;
            border: 1px solid var(--border-color); background-color: var(--bg-paper);
            box-shadow: var(--shadow-hover); border-radius: var(--border-radius);
        }

        .detail-content-wrapper h1 {
            color: var(--text-default); font-size: 3rem; margin-bottom: 10px; line-height: 1.2;
        }

        /* Meta Data Styling */
        .meta-container {
            display: flex; align-items: center; gap: 20px; margin-bottom: 30px;
            padding: 15px 0; border-bottom: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
        }
        .meta-container img {
            width: 70px; height: 70px; border-radius: 50%; object-fit: cover;
            border: 4px solid var(--primary-color); flex-shrink: 0;
        }
        .meta-info h3 { margin: 0; color: var(--primary-color); font-size: 1.3em; font-weight: 600; }
        .meta-info p { margin: 0; font-size: 0.95em; color: var(--text-secondary); }

        /* Post Content Styling */
        .post-body {
            padding: 30px 0; margin-top: 30px; line-height: 1.8; font-size: 1.1rem;
            border-top: 1px solid var(--border-color); word-wrap: break-word; overflow-wrap: break-word;
        }
        .thumbnail-image {
            width: 100%; height: 400px; object-fit: cover; border-radius: var(--border-radius);
            margin-bottom: 30px; box-shadow: var(--shadow-lg); cursor: pointer; overflow: hidden;
        }
        .thumbnail-image img, .thumbnail-image video {
            width: 100%; height: 100%; object-fit: cover; display: block;
        }

        /* Media Gallery */
        .post-media-gallery {
            margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--border-color); position: relative;
        }
        .post-media-gallery h3 { color: var(--text-default); margin-bottom: 20px; }
        .media-viewer {
            position: relative; width: 100%; height: 500px; overflow: hidden;
            background-color: #000; border-radius: var(--border-radius); box-shadow: var(--shadow-hover);
        }
        .media-item {
            display: none; width: 100%; height: 100%; cursor: pointer;
            justify-content: center; align-items: center; transition: opacity 0.3s;
        }
        .media-item img, .media-item video {
            width: auto; max-width: 100%; max-height: 100%; object-fit: contain; display: block;
        }
        .media-item.active { display: flex; }
        .gallery-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6); color: white; border: none; padding: 20px;
            cursor: pointer; z-index: 50; font-size: 28px; line-height: 1;
            transition: background-color 0.2s; border-radius: 50%; opacity: 0.8;
        }
        .gallery-nav:hover { background-color: rgba(0, 0, 0, 0.9); opacity: 1; }
        #prev-media { left: 15px; }
        #next-media { right: 15px; }

        /* Lightbox */
        #lightbox-modal {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.95);
            justify-content: center; align-items: center; overflow: hidden;
        }
        #lightbox-content {
            display: flex; justify-content: center; align-items: center;
            width: 95%; max-width: 1400px; height: 95vh;
        }
        #lightbox-content img, #lightbox-content video {
            max-width: 100%; max-height: 100%; object-fit: contain; margin: 0; display: block;
        }
        .lightbox-close {
            position: absolute; top: 20px; right: 40px; color: #f8f9fa; font-size: 50px;
            font-weight: bold; cursor: pointer; z-index: 3001; transition: color 0.2s;
        }
        .lightbox-close:hover { color: var(--primary-color); }
        .lightbox-nav {
            position: absolute; top: 50%; color: #f8f9fa; padding: 25px;
            font-size: 60px; font-weight: bold; cursor: pointer; user-select: none;
            transform: translateY(-50%); transition: opacity 0.2s;
        }
        #lightbox-prev { left: 10px; }
        #lightbox-next { right: 10px; }
        
        /* TinyMCE Dark Mode Styling */
        html.dark .tox .tox-editor-header,
        html.dark .tox .tox-toolbar-overlord {
            background-color: var(--bg-default) !important;
            border-color: var(--border-color) !important;
        }
        html.dark .tox .tox-edit-area,
        html.dark .tox .tox-statusbar {
            background-color: var(--bg-paper) !important;
            color: var(--text-default) !important;
            border-color: var(--border-color) !important;
        }
        html.dark .tox {
            color: var(--text-default) !important;
        }
        html.dark .tox .tox-tbtn svg,
        html.dark .tox .tox-tbtn--select__label,
        html.dark .tox .tox-toolbar-label {
             fill: var(--text-default) !important;
             color: var(--text-default) !important;
        }
        /* Fix for button backgrounds in dark mode */
        html.dark .tox .tox-tbtn:hover {
            background-color: var(--border-color) !important;
        }
        
        /* TinyMCE Light Mode Base Styling & Sizing */
        .tox-tinymce {
            border-radius: 0.5rem !important;
            border-color: #d1d5db !important;
        }
        .tox .tox-edit-area__iframe {
            min-height: 250px !important; /* Make the editor a decent size */
        }

        /* Mobile adjustments for detail view */
        @media (max-width: 768px) {
            .detail-content-wrapper { padding: 15px; margin: 15px auto; max-width: 100%; }
            .detail-content-wrapper h1 { font-size: 2.25rem; }
            .thumbnail-image, .media-viewer { height: 300px; }
        }
    </style>
    </head>

<body class="p-4 md:p-8 pb-20">

    <div class="max-w-7xl mx-auto">

        <div class="max-w-4xl mx-auto">
            <div class="bg-paper p-6 md:p-8 rounded-xl shadow-lg border-2 border-primary-color relative overflow-hidden">
                
                <div class="absolute top-0 left-0 h-2 bg-primary-color transition-all duration-300" id="progress-bar" style="width: 50%;"></div>
                
                <h2 class="text-2xl font-bold mb-6 pt-2 text-text-default text-center" id="form-header">Step 1: Your Author Profile</h2>

                <form id="submission-form" class="overflow-hidden">
                    
                    <div class="form-slider" id="form-slider">
                        
                        <div class="form-step px-1">
                            <label for="name" class="block text-sm font-medium mb-2 text-text-default">Your Full Name</label>
                            <input type="text" id="name" name="name"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-color focus:border-primary-color outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 transition duration-150">


                            <label for="pfp_image" class="block text-sm font-medium mb-2 mt-5 text-text-default">Profile Picture URL </label>
                            <input type="url" id="pfp_image" name="pfp_image" placeholder="https://example.com/pfp.jpg"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-color focus:border-primary-color outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 transition duration-150">
                            
                            <label for="bio" class="block text-sm font-medium mb-2 mt-5 text-text-default">Short Author Bio</label>
                            <textarea id="bio" name="bio" rows="3"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-color focus:border-primary-color outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 transition duration-150"
                                placeholder="e.g., A software developer passionate about CSS and responsive design."></textarea>
                            
                            <button type="button" onclick="nextStep()" id="next-step-button" disabled
                                class="w-full mt-8 py-3 px-4 text-white font-bold rounded-lg shadow-xl 
                                bg-gray-400 cta-pop-shadow-danger cursor-not-allowed 
                                transform hover:translate-y-0 transition duration-200">
                                Continue to Post Details &rarr;
                            </button>
                        </div>
                        
                        <div class="form-step px-1">
                            <label for="post_title" class="block text-sm font-medium mb-2 text-text-default">Post Title</label>
                            <input type="text" id="post_title" name="post_title"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-color focus:border-primary-color outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 transition duration-150">

                            <label for="post_thumbnail" class="block text-sm font-medium mb-2 mt-5 text-text-default">Post Thumbnail URL </label>
                            <input type="url" id="post_thumbnail" name="post_thumbnail" placeholder="https://example.com/thumb.jpg"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-color focus:border-primary-color outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 transition duration-150">

                            <label for="post_images" class="block text-sm font-medium mb-2 mt-5 text-text-default">Additional Images/Media URLs </label>
                            <input type="url" id="post_images" name="post_images" placeholder="https://img1.png, https://img2.gif (comma-separated)"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-color focus:border-primary-color outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 transition duration-150">
                            
                            <label for="post_content" class="block text-sm font-medium mb-2 mt-5 text-text-default">Post Content (Rich Text Editor)</label>
                            
                            <div id="editor-container" class="mt-2 mb-4">
                                <textarea id="post_content_editor" name="post_content_editor" 
                                    class="w-full p-3 h-80 border border-gray-300 rounded-lg outline-none 
                                        dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"></textarea>
                            </div>
                            <input type="hidden" id="post_content" name="post_content">
                            
                            <div class="flex flex-col gap-4 mt-4">
                                <div class="flex gap-4">
                                    <button type="button" onclick="prevStep()" 
                                        class="w-1/3 py-3 px-4 border border-gray-300 dark:border-gray-600 text-text-secondary font-semibold rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-200 z-10 relative">
                                        &larr; Back
                                    </button>
                                    <button type="button" onclick="copyHtmlContent()"  
                                        class="w-1/3 py-3 px-4 bg-blue-500 text-white font-bold rounded-lg shadow-xl hover:bg-blue-600 transform hover:-translate-y-0.5 transition duration-200 z-10 relative">
                                        Copy HTML
                                    </button>
                                    <button type="button" onclick="openPostDetail(createPostPreviewObject())"  
                                        class="w-1/3 py-3 px-4 bg-green-600 text-white font-bold rounded-lg shadow-xl hover:bg-green-700 transform hover:-translate-y-0.5 transition duration-200 z-10 relative">
                                        Preview Post
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

<footer style="
    margin-top: 50px;
    padding: 30px 0;
    text-align: center;
    border-top: 1px solid var(--border-color);
    font-size: 0.9rem;
    color: var(--text-secondary);
">
    <div style="max-width: 1300px; margin: 0 auto;">
        <p style="margin: 5px 0;">&copy; 2025 The Mahdi Yasser Blog. All rights reserved.</p>
        <p style="margin: 5px 0;">A modern blog experience built by <a href="/" style="color: var(--primary-color);">Mahdi Yasser</a>. <br>
 <a href="/blog/pages/terms-privacy-conditions" style="color: var(--primary-color);">Privacy Policy and Terms and Conditions</a></p>
    </div>
</footer>

<div id="post-detail-page">
    <div class="detail-header">
        <button class="back-btn" onclick="closePostDetail()">
           < Back to Details
        </button>
    </div>
    <div class="detail-content-wrapper">
        <div id="post-detail-content">
            </div>
    </div>
</div>

<div id="lightbox-modal">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <div id="lightbox-content"></div>
    <span id="lightbox-prev" class="lightbox-nav" onclick="lightboxNav(-1)">&#10094;</span>
    <span id="lightbox-next" class="lightbox-nav" onclick="lightboxNav(1)">&#10095;</span>
</div>

    <script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js"></script>
    
    <script>
    const htmlElement = document.documentElement;
    
    // --- Theme Toggle Logic (Same as before) ---
    function applyTheme() {
        const isDarkMode = localStorage.getItem('theme') === 'dark' || 
                            (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDarkMode) htmlElement.classList.add('dark');
        else htmlElement.classList.remove('dark');
    }
    document.addEventListener('DOMContentLoaded', applyTheme);
    
    // Function to apply custom TinyMCE styles based on theme
    function applyTinyMCEStyles() {
        const isDarkMode = htmlElement.classList.contains('dark');
        const theme = isDarkMode ? 'dark' : 'oxide';
        
        // This is a placeholder for dynamic theme loading in TinyMCE if needed,
        // but often only requires a full re-initialization or the use of the 
        // 'skin' and 'content_css' options on initialization.
        // For simplicity, we mostly rely on the custom CSS injected in the <style> block.
        // If TinyMCE is already initialized, we don't re-initialize it here.
    }
    
    // Re-apply styles on theme change
    new MutationObserver(applyTinyMCEStyles).observe(htmlElement, { attributes: true, attributeFilter: ['class'] });


    // --- TINYMCE INITIALIZATION ---
    let editor;

    document.addEventListener('DOMContentLoaded', () => {
        tinymce.init({
            selector: 'textarea#post_content_editor',
            // Use the dark theme if required
            skin: htmlElement.classList.contains('dark') ? 'oxide-dark' : 'oxide',
            content_css: htmlElement.classList.contains('dark') ? 'dark' : 'default',
            
            // Core Plugins (Removed 'image' plugin entirely)
            plugins: 'advlist autolink lists link charmap preview anchor code fullscreen insertdatetime media table help wordcount',
            
            // Toolbar configuration
            // Note: We use 'blocks' for the Header dropdown. 'media' is for videos/embeds. 'link' for URLs.
            // 'code' provides the source view requested by the user.
            toolbar: 'undo redo | blocks fontfamily fontsize | ' +
                     'bold italic underline strikethrough | forecolor backcolor | ' +
                     'alignleft aligncenter alignright alignjustify | ' +
                     'bullist numlist outdent indent | link media | code removeformat | fullscreen',
            
            // Custom font list (9 distinct fonts)
            font_formats: 
                "Inter=Inter, sans-serif; " +
                "Roboto=Roboto, sans-serif; " +
                "Open Sans=Open Sans, sans-serif; " +
                "Monoton=Monoton, cursive; " +
                "Cutive Mono=Cutive Mono, monospace; " +
                "Permanent Marker=Permanent Marker, cursive; " +
                "Courier Prime=Courier Prime, monospace; " +
                "Indie Flower=Indie Flower, cursive; " +
                "Bebas Neue=Bebas Neue, sans-serif",
            
            fontsize_formats: '10pt 12pt 14pt 16pt 18pt 24pt 36pt',
            
            // Disable default image handlers to ensure no file upload is possible
            file_picker_callback: (cb, value, meta) => {
                 if (meta.filetype === 'image') {
                    // Force URL input for images (TinyMCE uses the media plugin for this now)
                    // Or, simply do nothing to prevent the default behavior
                 }
            },
            
            // Initial content to prevent TinyMCE from being blank
            setup: function (ed) {
                editor = ed;
                ed.on('init', function(e) {
                    // Set initial content and update hidden field on change
                    ed.setContent(document.getElementById('post_content').value || '');
                });
                ed.on('change', updateHiddenField);
                ed.on('undo', updateHiddenField);
                ed.on('redo', updateHiddenField);
                ed.on('remove', function() { editor = null; });
            }
        });
        
        function updateHiddenField() {
            if (editor) {
                // TinyMCE uses getContent() to retrieve the HTML
                document.getElementById('post_content').value = editor.getContent().trim();
            }
        }
    });

    // --- Content Retrieval Functions Updated for TinyMCE ---

    window.copyHtmlContent = function() {
        if (!editor) {
            alert('Editor not initialized.');
            return;
        }

        // 1. Get the raw HTML content from the hidden input (updated by TinyMCE hook)
        const html = document.getElementById('post_content').value;
        
        // 2. Use the simpler, cross-browser fallback method
        const textarea = document.createElement('textarea');
        textarea.value = html;
        // Position off-screen
        textarea.style.position = 'fixed';
        textarea.style.top = '0';
        textarea.style.left = '0';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            document.execCommand('copy');
            alert('Post HTML copied to clipboard!');
        } catch (err) {
            console.error('Could not copy text using execCommand: ', err);
            alert('Failed to copy HTML. Please copy manually from the console.');
            console.log("Raw HTML:", html);
        }
        
        document.body.removeChild(textarea);
    }

    // --- Two-Step Form Logic (Step 1 Button Fix Implemented here) ---
    const slider = document.getElementById('form-slider');
    const header = document.getElementById('form-header');
    const progressBar = document.getElementById('progress-bar');
    const nextButton = document.getElementById('next-step-button');
    const submissionForm = document.getElementById('submission-form');

    let currentStep = 1;
    const requiredInputs = [
        document.getElementById('name'),
    ];

    function checkStep1Validity() {
        const isValid = requiredInputs.every(input => input.value.trim() !== '');
        
        let classes = nextButton.className;
        // Remove old style classes that are replaced by logic below
        classes = classes
            .replace(/bg-(red|green|gray)-\d+/g, '')
            .replace(/cta-pop-shadow-(danger|success)/g, '')
            .replace(/opacity-\d+/g, '')
            .replace(/cursor-not-allowed/g, '')
            .replace(/hover:bg-(red|green|gray)-\d+/g, '')
            .replace(/transform hover:(-translate-y-0\.5|translate-y-0)/g, '');

        if (isValid) {
            nextButton.disabled = false;
            // ACTIVE STATE: Green button, allows hover
            classes += ' bg-green-600 cta-pop-shadow-success hover:bg-green-700 transform hover:-translate-y-0.5 text-white'; 
            
        } else {
            nextButton.disabled = true;
            // DISABLED STATE: Visible Gray button, no hover effect, blocked cursor
            classes += ' bg-gray-400 dark:bg-gray-600 cta-pop-shadow-danger cursor-not-allowed transform hover:translate-y-0 text-white'; 
        }
        
        nextButton.className = classes.trim();

        const formStep1 = document.querySelector('.form-step:nth-child(1)');
        let msg = formStep1.querySelector('.validation-error');
        
        if (!isValid) {
            if (!msg) {
                msg = document.createElement('p');
                msg.className = 'validation-error text-red-500 text-sm mt-2 font-medium';
                nextButton.parentNode.insertBefore(msg, nextButton);
            }
            msg.textContent = 'Please fill in your full name at least before continuing.';
        } else {
             if (msg) msg.remove();
        }

        return isValid;
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkStep1Validity();
        requiredInputs.forEach(input => {
            input.addEventListener('input', checkStep1Validity);
        });
    });
    
    function validateStep1() {
        return checkStep1Validity();
    }

    function nextStep() {
        if (currentStep === 1) {
            if (!validateStep1()) return; 
            
            currentStep = 2;
            slider.style.transform = 'translateX(-100%)';
            header.textContent = 'Step 2: Post Details';
            progressBar.style.width = '100%';
            document.getElementById('form-header').scrollIntoView({behavior: 'smooth', block: 'start'});
        }
    }

    function prevStep() {
        if (currentStep === 2) {
            currentStep = 1;
            slider.style.transform = 'translateX(0)';
            header.textContent = 'Step 1: Your Author Profile';
            progressBar.style.width = '50%';
        }
    }

    // --- POST PREVIEW LOGIC (Same as before) ---
    let currentPostMedia = []; 
    let currentMediaIndex = 0; 
    const POST_DETAIL_PAGE = document.getElementById('post-detail-page');

    function isVideo(url) {
        return /\.(mp4|webm|ogg|mov)$/i.test(url);
    }
    
    function renderMediaGallery(mediaUrls) {
        if (mediaUrls.length === 0) return '';
        
        const mediaItemsHtml = mediaUrls.map((url, totalIndex) => {
            let mediaElement;
            const fullIndex = totalIndex + 1; // 1-based index for additional media
            if (isVideo(url)) {
                mediaElement = `<div class="media-item" data-index="${fullIndex}" onclick="openLightbox(${fullIndex})">
                                    <video controls loop preload="none">
                                        <source src="${url}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>`;
            } else {
                mediaElement = `<div class="media-item" data-index="${fullIndex}" onclick="openLightbox(${fullIndex})">
                                    <img src="${url}" alt="Post Media" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/300x200/4b5563/ffffff?text=Image+Load+Error'">
                                </div>`;
            }
            return mediaElement;
        }).join('');
        
        return `
            <div class="post-media-gallery">
                <h3>Media Gallery (${mediaUrls.length})</h3>
                <div class="media-viewer">
                    ${mediaItemsHtml}
                    <button id="prev-media" class="gallery-nav" onclick="galleryNav(-1)">&#10094;</button>
                    <button id="next-media" class="gallery-nav" onclick="galleryNav(1)">&#10095;</button>
                </div>
            </div>
        `;
    }

    function showMedia() {
        const items = document.querySelectorAll('#post-detail-content .media-viewer .media-item');
        if (!items || items.length === 0) return;
        const localIndex = currentMediaIndex - 1; 
        items.forEach((item, index) => {
            const isActive = index === localIndex;
            item.classList.toggle('active', isActive);
            const video = item.querySelector('video');
            if (video) {
                if (isActive) { video.currentTime = 0; video.play(); } else { video.pause(); }
            }
        });
        // Ensure nav buttons are visible only if there are multiple images in the gallery (excluding thumbnail)
        document.getElementById('prev-media').style.display = items.length > 1 ? 'block' : 'none';
        document.getElementById('next-media').style.display = items.length > 1 ? 'block' : 'none';
    }

    window.galleryNav = function(direction) {
        const mediaLength = currentPostMedia.length;
        if (mediaLength <= 2) return; // Only cycle additional media (index 1 to end)
        
        let newIndex = currentMediaIndex + direction;
        const additionalMediaStart = 1;
        const additionalMediaEnd = mediaLength - 1;

        if (newIndex < additionalMediaStart) newIndex = additionalMediaEnd; 
        else if (newIndex > additionalMediaEnd) newIndex = additionalMediaStart;
        
        currentMediaIndex = newIndex;
        showMedia();
    }

    // --- FORM DATA HELPER FOR PREVIEW (Updates hidden field via TinyMCE hook) ---
    function createPostPreviewObject() {
        // Ensure the hidden input value is current right before creating the preview object
        if (editor) {
             document.getElementById('post_content').value = editor.getContent().trim();
        }
        
        return {
            'author-name': document.getElementById('name').value.trim() || 'John Doe',
            'author-avatar': document.getElementById('pfp_image').value.trim() || 'https://via.placeholder.com/70/3b82f6/ffffff?text=A',
            'bio': document.getElementById('bio').value.trim() || 'A passionate tech writer.',
            'post-title': document.getElementById('post_title').value.trim() || 'My Awesome Post Title',
            'post-thumbnail': document.getElementById('post_thumbnail').value.trim() || 'https://via.placeholder.com/800x450/4b5563/ffffff?text=Thumbnail+Preview',
            'post-content': document.getElementById('post_content').value.trim() || '<p>Preview content here.</p>',
            'post-images': document.getElementById('post_images').value.trim()
        };
    }

    window.openPostDetail = function(post) {
        if (!post['post-title'] || !post['post-thumbnail'] || !post['post-content'] || !post['author-name'] || !post['bio']) {
             alert('Please fill in all required fields (Name, Bio, Post Title, Thumbnail URL, Content) to generate a full preview.');
             return;
        }

        const content = document.getElementById('post-detail-content');
        const postTitle = post['post-title'];
        const postContent = post['post-content'];
        const thumbnail = post['post-thumbnail'];
        const authorName = post['author-name'];
        const authorBio = post['bio'];
        const authorAvatar = post['author-avatar'];
        
        const formattedDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) + " (Preview)";

        // 1. Build Master Media Array
        currentPostMedia = [thumbnail]; // Thumbnail is always index 0
        const additionalImages = post['post-images'] ? post['post-images'].split(',').map(url => url.trim()).filter(url => url) : [];
        currentPostMedia.push(...additionalImages);
        currentMediaIndex = 0; // Always start at thumbnail when opening the detail view

        // 2. Thumbnail HTML
        const thumbnailMediaTag = `<div class="thumbnail-image" onclick="openLightbox(0)">
            ${isVideo(thumbnail) ? 
                `<video controls loop preload="none" onerror="this.onerror=null;this.src=''">
                    <source src="${thumbnail}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>` :
                `<img src="${thumbnail}" alt="Post Thumbnail" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x450/4b5563/ffffff?text=Thumbnail+Preview'">`
            }
        </div>`;

        // 3. Gallery HTML
        const galleryMedia = currentPostMedia.slice(1);
        const mediaGalleryHtml = galleryMedia.length > 0 ? renderMediaGallery(galleryMedia) : ''; 

        // 4. EXACT HTML STRUCTURE FROM TRACKING PAGE
        content.innerHTML = `
            <h1>${postTitle}</h1>
            <div class="meta-container">
                <img src="${authorAvatar}" alt="${authorName}'s profile picture" onerror="this.onerror=null;this.src='https://via.placeholder.com/70/3b82f6/ffffff?text=A'">
                <div class="meta-info">
                    <h3>${authorName}</h3>
                    <p>${authorBio}</p>
                    <p>Submitted on:<br> ${formattedDate}</p> 
                </div>
            </div>
            ${thumbnailMediaTag}
            <div class="post-body">
                ${postContent}
            </div>
            ${mediaGalleryHtml}
        `;

        POST_DETAIL_PAGE.style.display = 'block';
        setTimeout(() => { POST_DETAIL_PAGE.classList.add('active'); document.body.style.overflow = 'hidden'; }, 10); 
        POST_DETAIL_PAGE.scrollTop = 0; 
        
        // Start gallery at index 1 (first additional media) if a gallery exists.
        if (galleryMedia.length > 0) { currentMediaIndex = 1; setTimeout(showMedia, 100); }
    }

    window.closePostDetail = function() {
        POST_DETAIL_PAGE.classList.remove('active');
        document.body.style.overflow = ''; 
        document.querySelectorAll('#post-detail-content video').forEach(v => v.pause());
        setTimeout(() => { if (!POST_DETAIL_PAGE.classList.contains('active')) POST_DETAIL_PAGE.style.display = 'none'; }, 400);
    }

    // --- LIGHTBOX LOGIC (Same as before) ---
    window.openLightbox = function(index) {
        document.querySelectorAll('#post-detail-content video').forEach(v => v.pause()); // Pause any playing video on the post detail page
        currentMediaIndex = index;
        document.getElementById('lightbox-modal').style.display = "flex"; 
        updateLightboxContent();
    }
    window.closeLightbox = function() {
        document.getElementById('lightbox-modal').style.display = "none";
        const video = document.querySelector('#lightbox-content video');
        if (video) video.pause();
    }
    function updateLightboxContent() {
        const content = document.getElementById('lightbox-content');
        const mediaUrl = currentPostMedia[currentMediaIndex];
        let mediaHtml;
        if (isVideo(mediaUrl)) {
            mediaHtml = `<video controls autoplay loop><source src="${mediaUrl}" type="video/mp4"></video>`;
        } else {
            mediaHtml = `<img src="${mediaUrl}" alt="Full view media" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x600/4b5563/ffffff?text=Image+Load+Error'">`;
        }
        content.innerHTML = mediaHtml;
        
        const showNav = currentPostMedia.length > 1;
        document.getElementById('lightbox-prev').style.display = showNav ? 'block' : 'none';
        document.getElementById('lightbox-next').style.display = showNav ? 'block' : 'none';
    }
    window.lightboxNav = function(direction) {
        const mediaLength = currentPostMedia.length;
        if (mediaLength <= 1) return;
        let newIndex = currentMediaIndex + direction;
        if (newIndex < 0) newIndex = mediaLength - 1; else if (newIndex >= mediaLength) newIndex = 0;
        currentMediaIndex = newIndex;
        updateLightboxContent();
    }
    
</script>
</body>
</html>
